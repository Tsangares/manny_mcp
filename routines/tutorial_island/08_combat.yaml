# Tutorial Island - Part 8: Combat
# STATUS: VALIDATED (2026-01-18)
#
# This routine handles the Combat section:
# 1. Talk to Combat Instructor
# 2. Open equipment tab and equip bronze dagger
# 3. Get bronze sword and wooden shield
# 4. Open combat tab
# 5. Enter rat cage and attack giant rat (melee)
# 6. Receive bow and arrows
# 7. Attack giant rat (ranged)
# 8. Exit to banking section

name: "Tutorial Island - Combat"
type: tutorial
phase: 8

# Key NPCs
npcs:
  combat_instructor:
    name: "Combat Instructor"
    id: 3307
    location: {x: 3104, y: 9508, plane: 0}
  giant_rat:
    name: "Giant rat"
    id: 3313
    action: "Attack"
    combat_level: 3

# Key Locations (VALIDATED)
locations:
  combat_area_entrance: {x: 3104, y: 9509, plane: 0}
  rat_cage_gate: {x: 3111, y: 9519, plane: 0}
  exit_ladder: {x: 3111, y: 9526, plane: 0}

# Key Widgets (VALIDATED)
widgets:
  continue_button: 12648448
  equipment_tab: 35913771  # Use find_and_click_widget(text="Worn Equipment")
  combat_options_tab: 35913792  # Has action "Combat Options"
  inventory_tab: 35913795  # Action: "Inventory", bounds (626, 168, 33, 36)
  inventory_container: 9764864  # Group 149 << 16
  # Equipment stats panel (AVOID - blocks inventory):
  equip_panel_title: 5505027  # Text: "Equip Your Character...", group 84 child 3
  view_equipment_stats: 25362433  # DON'T USE - just for reference

# PITFALLS DISCOVERED:
# 1. Equipment stats panel BLOCKS INVENTORY - don't use it!
#    Use get_game_state(fields=["equipment"]) instead for equipment info.
#    DETECTION: find_widget("Equip your character") returns 5505027 when panel is open
#    FIX: Press ESC to close panel, then click inventory_tab (35913795)
# 2. find_widget for inventory items returned WRONG BOUNDS (slot 0 for all)
#    FIX: ScanWidgetsCommand.java now calculates grid position from slot index
# 3. equip_item() clicked first "Wield"-able item instead of specific item
#    FIX: equip_item now uses xdotool with bounds from find_widget
# 4. Dialogue advancement: Use KEY_PRESS space (most reliable)

steps:
  # Phase 1: Initial dialogue and equipment tab
  - id: 1
    description: "Talk to Combat Instructor"
    action: INTERACT_NPC
    args: "Combat_Instructor Talk-to"
    await_condition: "dialogue"
    status: "VALIDATED"
    notes: "Player receives bronze dagger automatically"

  - id: 2
    description: "Advance dialogue (receive bronze dagger)"
    action: KEY_PRESS
    args: "space"
    repeat_until: "no_dialogue"
    status: "VALIDATED"
    notes: "Press space multiple times until dialogue closes"

  - id: 3
    description: "Open equipment tab"
    mcp_tool: "find_and_click_widget"
    args:
      text: "Worn Equipment"
    status: "VALIDATED"
    notes: "Widget 35913771, found via action text"

  - id: 4
    description: "Equip bronze dagger"
    mcp_tool: "equip_item"
    args:
      item_name: "Bronze dagger"
    status: "VALIDATED"
    notes: "equip_item now works correctly after fix"

  # Phase 2: Get sword and shield
  - id: 5
    description: "Talk to Combat Instructor (get sword/shield)"
    action: INTERACT_NPC
    args: "Combat_Instructor Talk-to"
    await_condition: "dialogue"
    status: "VALIDATED"

  - id: 6
    description: "Advance dialogue (receive sword and shield)"
    action: KEY_PRESS
    args: "space"
    repeat_until: "no_dialogue"
    status: "VALIDATED"
    notes: "Receive bronze sword and wooden shield"

  - id: 7
    description: "Equip bronze sword"
    mcp_tool: "equip_item"
    args:
      item_name: "Bronze sword"
    status: "VALIDATED"

  - id: 8
    description: "Equip wooden shield"
    mcp_tool: "equip_item"
    args:
      item_name: "Wooden shield"
    status: "VALIDATED"

  # Phase 3: Combat tab and melee
  - id: 9
    description: "Open combat options tab"
    action: CLICK_WIDGET
    args: "35913792"
    status: "VALIDATED"
    notes: "Found via find_widget with action 'Combat Options'"

  - id: 10
    description: "Enter rat cage through gate"
    action: INTERACT_OBJECT
    args: "Gate Open"
    status: "VALIDATED"

  - id: 11
    description: "Attack giant rat (melee)"
    action: INTERACT_NPC
    args: "Giant_rat Attack"
    status: "VALIDATED"
    notes: "Wait for combat to complete, rat will die"

  # Phase 4: Ranged combat
  - id: 12
    description: "Talk to Combat Instructor (get bow)"
    action: INTERACT_NPC
    args: "Combat_Instructor Talk-to"
    await_condition: "dialogue"
    status: "VALIDATED"
    notes: "Exit rat cage first if still inside"

  - id: 13
    description: "Advance dialogue (receive bow and arrows)"
    action: KEY_PRESS
    args: "space"
    repeat_until: "no_dialogue"
    status: "VALIDATED"
    notes: "Receive shortbow and 50 bronze arrows"

  - id: 14
    description: "Equip shortbow"
    mcp_tool: "equip_item"
    args:
      item_name: "Shortbow"
    status: "VALIDATED"

  - id: 15
    description: "Equip bronze arrows"
    mcp_tool: "equip_item"
    args:
      item_name: "Bronze arrow"
    status: "VALIDATED"

  - id: 16
    description: "Attack giant rat (ranged)"
    action: INTERACT_NPC
    args: "Giant_rat Attack"
    status: "VALIDATED"
    notes: "Stay outside cage, attack through fence"

  # Phase 5: Exit to banking
  - id: 17
    description: "Walk to exit ladder"
    action: GOTO
    args: "3111 9525 0"
    status: "VALIDATED"

  - id: 18
    description: "Climb up ladder"
    action: INTERACT_OBJECT
    args: "Ladder Climb-up"
    await_condition: "plane:0"
    status: "VALIDATED"
    notes: "Exits to surface, continue to banking section"

# WORKING PATTERNS SUMMARY:
# - Dialogue: KEY_PRESS space (most reliable)
# - Equipment tab: find_and_click_widget(text="Worn Equipment")
# - Combat tab: CLICK_WIDGET 35913792
# - Equipping: equip_item(item_name="X") - works after fix
# - Attacking: INTERACT_NPC Giant_rat Attack
# - Object interaction: INTERACT_OBJECT Gate Open
